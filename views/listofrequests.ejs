<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/stylesheets/style.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link href="https://fonts.googleapis.com/css2?family=Kanit&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined&display=block">
    <title>
        <%= title %>
    </title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f9f9f9;
        }

        .main-content {
            margin-left: 250px;
            /* ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å sidebar */
            padding: 20px;
            width: calc(100vw - 250px);
            /* ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏¥‡∏ô‡∏Ç‡∏≠‡∏ö‡∏à‡∏≠ */
            max-width: 100vw;
            /* ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡∏¥‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ */
            box-sizing: border-box;
            padding-top: 80px;
        }

        .topic {
            text-align: center;
            /* ‚úÖ ‡∏à‡∏±‡∏î‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á */
            color: #000080;
            /* ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏µ‡πÉ‡∏´‡πâ‡∏î‡∏π‡∏î‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô (‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£) */
        }

        #details-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.3s ease, visibility 0s 0.3s;
            overflow: auto;
            /* ‚úÖ ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡∏•‡∏á‡πÑ‡∏î‡πâ‡∏ñ‡πâ‡∏≤‡∏™‡∏π‡∏á‡πÄ‡∏Å‡∏¥‡∏ô‡∏à‡∏≠ */
        }

        /* ‡∏õ‡∏£‡∏±‡∏ö modal-content ‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏≠‡∏≠‡∏Å‡∏ô‡∏≠‡∏Å‡∏à‡∏≠ */
        .modal-content {
            background-color: #fff;
            padding: 20px;
            width: 60%;
            max-width: 800px;
            max-height: 90vh;
            /* ‚úÖ ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            text-align: left;
            overflow: auto;
            /* ‚úÖ ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏†‡∏≤‡∏¢‡πÉ‡∏ô modal ‡πÑ‡∏î‡πâ */
            position: relative;
        }


        #details-modal.show {
            visibility: visible;
            opacity: 1;
        }

        .button-container {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }

        /* Styling for Request Details */
        .request-box {
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .request-box h3 {
            font-size: 1.5rem;
            margin-bottom: 15px;
        }

        .request-box p {
            font-size: 1.1rem;
            margin-bottom: 10px;
        }

        .request-box p strong {
            font-weight: bold;
        }

        .status {
            font-size: 1.1rem;
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 4px;
        }

        .status.pending {
            background-color: #f0ad4e;
            color: white;
        }

        .status.approved {
            background-color: #000080;
            color: white;
        }

        .status.rejected {
            background-color: #d9534f;
            color: white;
        }

        button {
            background-color: #000080;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            margin-top: 10px;
        }

        button:hover {
            background-color: #7777bd;
        }

        .btn-back {
            background-color: #28a745;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
        }

        .btn-back:hover {
            background-color: #218838;
        }

        /* Modal Box Styling */
        .modal-content p {
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        #documents {
            margin-top: 20px;
        }
    </style>
</head>

<body>
    <div id="sidebar-container"></div>
    <%- include('partials/sidebar', { user: teacher }) %>

        <div class="header">
            <span class="material-symbols-outlined">menu</span>
            <h5 class="mb-0">‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏ù‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏Å‡∏≤‡∏£‡∏ì‡πå</h5>
            <span class="material-symbols-outlined">more_vert</span>
        </div>

        <div class="main-content">
            <h2 class="topic">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏ù‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏Å‡∏≤‡∏£‡∏ì‡πå</h2>
            <% requests.forEach(request=> { %>
                <div class="container mt-4">
                    <div class="request-box">
                        <h3>‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏à‡∏≤‡∏Å <%= request.student_name %>
                        </h3>
                        <p><strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏Å‡∏≤‡∏£:</strong>
                            <%= request.company_name %>
                        </p>
                        <p><strong>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏á‡∏≤‡∏ô:</strong>
                            <%= request.position_name %>
                        </p>
                        <p><strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏≥‡∏Ç‡∏≠:</strong>
                            <span
                                class="status 
                                <%= request.status === 'P' ? 'pending' : (request.status === 'A' ? 'approved' : 'rejected') %>">
                                <%= request.status==='P' ? '‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥' : (request.status==='A' ? '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥'
                                    : '‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥' ) %>
                            </span>
                        </p>
                        <button
                            onclick="showDetails('<%= request.student_id %>', '<%= request.student_name %>', '<%= request.company_name %>', '<%= request.position_name %>', '<%= request.request_start_date %>', '<%= request.request_end_date %>', '<%= request.request_id %>')">‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</button>
                    </div>
                </div>
                <% }) %>

        </div>
        </div>

        <!-- Modal -->
        <div id="details-modal">
            <div class="modal-content">
                <h3>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡∏≥‡∏Ç‡∏≠</h3>
                <p><strong>‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏≥‡∏Ç‡∏≠:</strong> <span id="detail-request-id"></span></p>
                <p><strong>‡∏ä‡∏∑‡πà‡∏≠:</strong> <span id="detail-name"></span></p>
                <p><strong>‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤:</strong> <span id="detail-student-id"></span></p>
                <p><strong>‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó:</strong> <span id="detail-company"></span></p>
                <p><strong>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á:</strong> <span id="detail-position"></span></p>
                <p><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°:</strong> <span id="detail-start-date"></span></p>
                <p><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î:</strong> <span id="detail-end-date"></span></p>
                <!-- ‚úÖ ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå -->
                <h4>üìÇ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏ô‡∏ö:</h4>
                <ul id="document-list"></ul>

                <!-- ‚úÖ ‡πÅ‡∏™‡∏î‡∏á PDF -->
                <p><strong>‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ PDF:</strong></p>
                <div id="documents"></div>
                <div class="button-container">
                    <button id="approve-button">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
                    <button id="reject-button">‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</button>
                    <button onclick="closeDetails()">‡∏õ‡∏¥‡∏î</button>
                </div>
            </div>
        </div>
        <div id="footer-container">
            <%- include('partials/footer.html') %> <!-- ‡πÅ‡∏™‡∏î‡∏á Footer -->
        </div>
        <script>
            function showDetails(studentId, studentName, companyName, positionName, startDate, endDate, requestId) {
                if (!requestId) {
                    console.error('Invalid or missing Request ID');
                    alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏≥‡∏Ç‡∏≠');
                    return;
                }

                document.getElementById('detail-name').innerText = studentName;
                document.getElementById('detail-student-id').innerText = studentId;
                document.getElementById('detail-company').innerText = companyName;
                document.getElementById('detail-position').innerText = positionName;
                document.getElementById('detail-start-date').innerText = formatDate(startDate);
                document.getElementById('detail-end-date').innerText = formatDate(endDate);
                document.getElementById('detail-request-id').innerText = requestId;

                fetch(`/documents/${requestId}`)
                    .then(response => {
                        if (!response.ok) throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£');

                        return response.json();
                    })
                    .then(data => {
                        const listContainer = document.getElementById('document-list');
                        const pdfContainer = document.getElementById('documents');

                        listContainer.innerHTML = ''; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏•‡∏¥‡∏™‡∏ï‡πå‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏°
                        pdfContainer.innerHTML = ''; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå PDF ‡πÄ‡∏î‡∏¥‡∏°

                        if (Array.isArray(data.foundDocuments) && data.foundDocuments.length > 0) {
                            data.foundDocuments.forEach(doc => {
                                const filePath = doc.file_path;
                                if (!filePath) return;

                                const fileName = filePath.split(/[\\/]/).pop(); // ‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏≤‡∏Å path
                                const fileUrl = `/${filePath}`;

                                // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
                                const listItem = document.createElement("li");
                                const fileLink = document.createElement("a");

                                fileLink.href = fileUrl;
                                fileLink.innerText = fileName;
                                fileLink.target = "_blank"; // ‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏ô‡πÅ‡∏ó‡πá‡∏ö‡πÉ‡∏´‡∏°‡πà
                                listItem.appendChild(fileLink);
                                listContainer.appendChild(listItem);

                                // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô PDF ‚Üí ‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô iframe
                                if (fileName.toLowerCase().endsWith('.pdf')) {
                                    loadPdfInIframe(fileUrl, pdfContainer);
                                }
                            });
                        } else {
                            listContainer.innerHTML = '<li>‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</li>';
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching documents:', error);
                        document.getElementById('document-list').innerHTML = '<li>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</li>';
                    });

                // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏õ‡∏∏‡πà‡∏°‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò
                document.getElementById('approve-button').onclick = () => updateRequestStatus(requestId, 'A');
                document.getElementById('reject-button').onclick = () => updateRequestStatus(requestId, 'R');

                document.getElementById('details-modal').classList.add('show');
            }

            // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á PDF ‡πÉ‡∏ô iframe
            function loadPdfInIframe(pdfUrl, container) {
                const iframe = document.createElement("iframe");
                iframe.src = pdfUrl;
                iframe.width = "100%";
                iframe.height = "500px";
                iframe.style.border = "none";
                container.appendChild(iframe);
            }

            function formatDate(dateString) {
                if (!dateString) return '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà';
                const date = new Date(dateString);
                return date.toLocaleDateString('th-TH');
            }

            function closeDetails() {
                document.getElementById('details-modal').classList.remove('show');
            }

            async function updateRequestStatus(requestId, status) {
                console.log('üì§ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á requestId:', requestId);
                console.log('üì§ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á status:', status);

                try {
                    const response = await fetch(`/listofrequests/update-status/${requestId}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ status }),
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || '‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏î‡πâ');
                    }

                    console.log('‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                    window.location.reload();
                } catch (error) {
                    console.error('‚ùå Error updating status:', error.message);
                    alert(`‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`);
                }
            }
        </script>
</body>

</html>